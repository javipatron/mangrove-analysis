---
title: "Silvestrum Assignment"
author: "Javier Patr√≥n"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

in this R Markdown we will calculate the sample sizes for the given data sets, and we will do an analysis with confusion matrixs to understand what are most important parameters from the field to calculate the total carbon per tree and per hectare. This step is important as when we are stratifying the sample plots we want to homogenize as much as possible meaning that we need to set priorities for the field samples.

The steps followed are.

1.  Download the libraries
2.  Read the data. Datasets:
    -   Abu Ali, Saudi Arabia (Site A)
    -   Delta Blue Carbon, Sindh Pakistan, (Site B)
    -   Sidnh Pakistan, Pakistan institute (Site C).
3.  Cleaning and tidy the data into the same format
4.  Bind the datasets into only one big df
5.  Create a pilot data set for understanding sample sizing with data variation and standard deviation.
6.  Calculate the different sample size with the proposed equations from the SOP.
7.  Perform the confusion matrix to understand the relationship between parameters and strengthen the SOP for calculating sample sizes

```{r, include = FALSE}
# 1. Load the libraries
library(tidyverse)
library(here)
library(janitor)
library(knitr)
library(pwr)
library(skimr)
library(tidymodels)
library(kableExtra)
library(corrplot)
library(stringr)
library(plotly)
library(stargazer)
library(car)
library(estimatr)

```

```{r, include = FALSE}

#2. Read the .cv files 
#Load the shared Mangrove Data from Silvestrum
mangrove_df_a <- read_csv("/Users/javipatron/Library/Mobile Documents/com~apple~CloudDocs/Documents/Silvestrum/EDS222-Stats/mangrove-analysis/data/sitea.csv") |> clean_names() #Clean names will make the column names as lower case

mangrove_df_b <- read_csv("/Users/javipatron/Library/Mobile Documents/com~apple~CloudDocs/Documents/Silvestrum/EDS222-Stats/mangrove-analysis/data/siteb.csv") |> clean_names() |> na.omit() #homogenizing the column names and adding NA to values


mangrove_df_c <- read_csv("/Users/javipatron/Library/Mobile Documents/com~apple~CloudDocs/Documents/Silvestrum/EDS222-Stats/mangrove-analysis/data/sitec.csv") |> 
  clean_names() |> 
  filter(!is.na(total_c_t_ha_34))

```

Note: Plot names ending with ".1" indicate modifications from the original dataset, where such plots were previously labeled with "\_new" or a similar suffix. This adjustment ensures consistency and clarity in plot identification throughout the analysis.

```{r, echo = F}
# Cleaning and changing the type of class of some columns
mangrove_df_a <- mangrove_df_a %>%
  mutate(plot = case_when(
    str_detect(plot, "_new$") ~ paste0(as.character(str_remove(plot, "_new")), ".1"),
    TRUE ~ plot))

```

```{r}
tidy_a <- mangrove_df_a |> 
  select(plantation_year, plot, plot_size_m2, height_cm, cd_chatting_m, total_tree_kg_c, total_tree_mg_c_ha) |> 
  mutate(site = "A",
         cd_chatting_m = cd_chatting_m * 100) |> 
  relocate(site, .before = plantation_year) |> 
  rename(year = plantation_year,
         plot_name = plot,
         crown_diameter_cm = cd_chatting_m,
         total_tree_c_kg = total_tree_kg_c,
         "total_tree_c_Mg_ha" = total_tree_mg_c_ha) |>
  mutate(plot_name = as.numeric(plot_name),
         new_plot_name = ifelse(plot_name < 10, sprintf("%g", plot_name), as.character(plot_name))) |> 
  relocate(new_plot_name, .after = plot_name)

```

```{r, echo = F}
tidy_b <- mangrove_df_b |> 
  select(year, plot, height_cm, crown_dia_m, total_c_kg, total_c_t_ha) |>
  mutate(plot_size_m2 = 153.938) |> 
  mutate(site = "B",
         crown_dia_m = crown_dia_m *100) |> 
  rename(plot_name = plot,
         total_tree_c_kg = total_c_kg,
         "total_tree_c_Mg_ha" = total_c_t_ha,
         crown_diameter_cm = crown_dia_m ) |> 
  relocate(site, .before = year) |> 
  relocate(plot_size_m2, .before = height_cm)

```

```{r, echo = F}
tidy_b <- tidy_b %>% 
  mutate(new_plot_name = str_extract(plot_name, "(?<=Sample Plot #\\s)\\d+")) |> 
  relocate(new_plot_name, .after = plot_name)
```

```{r}
tidy_c <- mangrove_df_c |> 
  select(year = year_of_plantation, 
         plot_name = plot_no,
         height_cm = ht_m_21,
         crown_diameter_cm = crown_dia_m, 
         total_tree_c_kg = total_c, 
         total_tree_c_Mg_ha = total_c_t_ha_34) |> 
  mutate(plot_size_m2 = 254.47,
         site = "C",
         height_cm = (as.numeric(height_cm)*100),
         crown_diameter_cm = as.numeric(crown_diameter_cm)*100) |> 
  relocate(site, .before = year) |> 
  relocate(plot_size_m2, .before = height_cm)

tidy_c <- tidy_c |>
  mutate(new_plot_name = ifelse(plot_name < 10, paste0("0", as.character(plot_name)), as.character(plot_name))) %>%
  relocate(new_plot_name, .after = plot_name)
  
```

Creating a row binding to have the same columns but all the information

```{r, echo = F}

full_df <- rbind(tidy_a, tidy_b, tidy_c) |> 
  mutate(plot_name = paste0("site", site, "_", year, "_plot_", new_plot_name)) |> 
  rename(full_plot_name = plot_name) |> 
  mutate(new_plot_name = paste0("Sample_Plot#", new_plot_name)) |> 
  rename(plot_name = new_plot_name) |> 
  relocate(full_plot_name, .before = height_cm)

```

Analyze and calculate the total number of plots per plantation year (project).

```{r}

# Creating a summary table for number of plots
summary_full_df <- full_df |> 
  group_by(site, year, plot_size_m2) |> 
  summarise(plot_count = length(unique(plot_name)),
            tree_count = n(),
            density = (tree_count/plot_count),
            mean_height_cm = mean(height_cm),
            sd_height_cm = sd(height_cm),
            mean_crown_diameter_cm = mean(crown_diameter_cm),
            sd_crown_diameter_cm = sd(crown_diameter_cm),
            mean_carbon_kg = mean(total_tree_c_kg),
            sd_carbon_kg = sd(total_tree_c_kg),
            mean_tot_carbon_Mg_ha = mean(total_tree_c_Mg_ha),
            sd_tot_carbon_Mg_ha = sd(total_tree_c_Mg_ha),
            std_error = sd_tot_carbon_Mg_ha/sqrt(plot_count)) |> 
  na.omit()


```

## Power Calculation

```{r}

power_vector <- c()

for(i in 1:nrow(summary_full_df)) {
  sd = as.numeric(summary_full_df$sd_carbon_kg[i])
  mean = as.numeric(summary_full_df$mean_carbon_kg[i])
  d1 = sqrt(sd^2 / 2)
  effect_size = mean / d1
  
  # Attempt to perform power calculation
  result <- try(pwr.t.test(d = effect_size, 
                           power = 0.90, 
                           sig.level = 0.05,
                           type = "two.sample",
                           alternative = "two.sided"), silent = TRUE)
  
  # Check if an error occurred and assign NA to new if so
  if(class(result) == "try-error") {
    new <- NA
  } else {
    new <- round(result$n, 1)
  }
  
  # Append the result or NA to the power_vector
  power_vector <- c(power_vector, new)
}


# Preparing the new data frame
sample_size_methods <- summary_full_df |> 
  dplyr::select(site, year, plot_size_m2, plot_count)

sample_size_methods$power_calc <- power_vector

```

## A/R Methodological tool

```{r}

full_plots <- full_df |> 
  group_by(site, year, plot_name) |> 
  summarise(tree_count = n(),
            density = tree_count/154,
            mean_height_cm = mean(height_cm),
            sd_height = sd(height_cm),
            mean_diameter_cm = mean(crown_diameter_cm),
            sd_diameter = sd(crown_diameter_cm),
            mean_biomass = mean(total_tree_c_kg),
            sd_biomass = sd(total_tree_c_kg),
            mean_carbon_Mg_ha = mean(total_tree_c_Mg_ha),
            sd_carbon_Mg_ha = sd(total_tree_c_Mg_ha),
            std_error = sd_carbon_Mg_ha/sqrt(tree_count)) |> 
  relocate(plot_name, .after = year)

```

```{r}

tvalue = 1.645
conf_interval <- t.test(summary_full_df$sd_carbon_kg, conf.level = 0.95)
lower <- conf_interval$conf.int[1]
upper <- conf_interval$conf.int[2]
E <- (upper - lower) / 2

ar_tool <- c()

for (i in 1:nrow(summary_full_df)){
  year_condition <- summary_full_df$year[i]
  w <- 154/(summary_full_df$plot_count[i]*154)
  s <- full_plots$sd_carbon_kg[which(full_plots$year == year_condition)]
  N <- summary_full_df$plot_count[i]
  n <- round((N * tvalue^2 * sum(w * s)^2) / (N * E^2 + (tvalue^2 * sum(w * s^2))),1)
  ar_tool <- c(ar_tool, n)
}

sample_size_methods$ar_tool <- ar_tool

```

## CIFOR

```{r}
# Define parameters
t_value <- 2  

# Calculate sample size
CIFOR <- (t_value * summary_full_df$sd_carbon_kg / summary_full_df$std_error)^2

# Add sample size as a new column to summary_full_df
sample_size_methods$CIFOR <- CIFOR

```

Field Sampling Create a correlation Matrix per dataset to see the importance of the variables for each site.

### Confusion Matrix for site A (Abu Ali, Saudi Arabia)

```{r, include = F}

mangrove_recipe <- mangrove_df_a |> 
  rename(crown_size_m = cd_chatting_m ) |> 
  select(c(plantation_year, 
           plot, 
           plot_size_m2, 
           height_cm,
           crown_size_m, 
           total_tree_kg_c, 
           total_tree_mg_c_ha)) |> 
  recipe(total_tree_mg_c_ha ~ .) |> 
  step_integer(plantation_year, 
               plot, 
               plot_size_m2,total_tree_mg_c_ha, zero_based = TRUE) |> 
  prep() |> 
  bake(new_data = NULL)

# Obtain correlation matrix
tree_matrix <- cor(mangrove_recipe)

# Make a correlation plot between the variables
corrplot(tree_matrix, 
         method = "shade", 
         shade.col = NA, 
         tl.col = "black", 
         tl.srt = 45, 
         addCoef.col = "black", 
         cl.pos = "n", 
         order = "original")
```

# Now lets see how the p-value mathes with this correlation matrix

```{r, echo = F}
# Create a dataframe for the significance symbols
significance_levels <- data.frame(
  `P-Value` = c("< 0.001", "0.001 - 0.01", "0.01 - 0.05", "0.05 - 0.1", "> 0.1"),
  `Symbol` = c("***", "**", "*", ".", " --- "),
  `Description` = c("Highly significant", "Very significant", "Significant", "Marginally significant", "Not significant")
)

# Use kable to create the table
kable(significance_levels, booktabs = TRUE, align = "c", caption = "Significance Levels Description") %>%
  kable_styling(full_width = FALSE)
```

```{r}
# Creating a matrix that calculates the p-value and prints out the results

calculate_p_values_signif <- function(data, columns) {
  p_value_matrix <- matrix(nrow = length(columns), ncol = length(columns),
                           dimnames = list(columns, columns), data = NA_character_)  # Ensure matrix is of character type
  for (i in 1:length(columns)) {
    for (j in 1:length(columns)) {
      if (i == j) {
        p_value_matrix[i, j] <- NA  # Keep NA for diagonal
      } else if (!all(is.na(data[[columns[i]]])) && !all(is.na(data[[columns[j]]]))) {
        test_result <- cor.test(data[[columns[i]]], data[[columns[j]]], method = "pearson", use = "complete.obs")
        p_value <- test_result$p.value
        if (p_value < 0.001) {
          p_value_matrix[i, j] <- "***"
        } else if (p_value < 0.01) {
          p_value_matrix[i, j] <- "**"
        } else if (p_value < 0.05) {
          p_value_matrix[i, j] <- "*"
        } else if (p_value < 0.1) {
          p_value_matrix[i, j] <- "."
        } else {
          p_value_matrix[i, j] <- "---"  # Non-significant
        }
      } else {
        p_value_matrix[i, j] <- NA  # Use NA for non-comparable pairs
      }
    }
  }
  return(p_value_matrix)
}
```

### P-Value correlation matrix. Site A

```{r}
selected_columns <- c("plantation_year", 
           "plot", 
           "plot_size_m2", 
           "height_cm",
           "crown_size_m", 
           "total_tree_kg_c", 
           "total_tree_mg_c_ha")

# Apply to the preprocessed data
p_value_matrix_signif <- calculate_p_values_signif(mangrove_recipe, selected_columns)

```

```{r}

colored_df <- as.data.frame.matrix(p_value_matrix_signif)

# Apply cell_spec to multiple specific cells for coloring
colored_df[5,2] <- cell_spec(colored_df[5,2], "html", background = "lightcoral")
colored_df[6,2] <- cell_spec(colored_df[6,2], "html", background = "lightcoral")
colored_df[2,5] <- cell_spec(colored_df[2,5], "html", background = "lightcoral")
colored_df[2,6] <- cell_spec(colored_df[2,6], "html", background = "lightcoral")

# Now, print the colored matrix as a table with the additional cells colored
kable(colored_df, "html", align = "c", escape = FALSE, booktabs = TRUE, caption = "P-Value Significance Matrix. SITE A") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F)

```

### Confusion Matrix for site B (Delta Blue Carbon, Sindh, Pakistan)

```{r, include = F}

mangrove_recipe <- mangrove_df_b |> 
  select(c(year,
           plot, 
           height_cm,
           crown_dia_m, 
           total_c_kg, 
           total_c_t_ha)) |> 
  recipe(total_c_t_ha ~ .) |> 
  step_integer(year,
               plot,
               total_c_t_ha, 
               zero_based = TRUE) |> 
  prep() |> 
  bake(new_data = NULL)

# Obtain correlation matrix
tree_matrix <- cor(mangrove_recipe)

# Make a correlation plot between the variables
corrplot(tree_matrix, 
         method = "shade", 
         shade.col = NA, 
         tl.col = "black", 
         tl.srt = 45, 
         addCoef.col = "white", 
         cl.pos = "n", 
         order = "original")
```

### P-Value correlation matrix. Site B

```{r}
# Pri

selected_columns <- c("year", 
           "plot",  
           "height_cm",
           "crown_dia_m", 
           "total_c_kg", 
           "total_c_t_ha")

# Apply to the preprocessed data
p_value_matrix_signif <- calculate_p_values_signif(mangrove_recipe, selected_columns)

# Print the matrix with significance codes
print(p_value_matrix_signif)

```

```{r}

colored_df <- as.data.frame.matrix(p_value_matrix_signif)

# Now, print the colored matrix as a table with the additional cells colored
kable(colored_df, "html", align = "c",escape = FALSE, booktabs = TRUE, caption = "P-Value Significance Matrix. SITE B") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F)
```

### Confusion Matrix for site C (Pakistan institute)

```{r, include = F}

mangrove_recipe <- mangrove_df_c |> 
  select(c(year_of_plantation,
           x_coordinate,
           y_coordinate,
           species,
           dbh = dbh_cm_19,
           height_m = ht_m_21,
           crown_dia_m,
           total_c,
           total_c_t_ha_34)) |> 
  na.omit() |> 
  recipe(total_c_t_ha_34 ~ .) |> 
  step_integer(year_of_plantation,
               x_coordinate,
               species, 
               zero_based = TRUE) |> 
  prep() |> 
  bake(new_data = NULL)

# Obtain correlation matrix
tree_matrix <- cor(mangrove_recipe)

# Make a correlation plot between the variables
corrplot(tree_matrix, 
         method = "shade", 
         shade.col = NA, 
         tl.col = "black", 
         tl.srt = 45, 
         addCoef.col = "white", 
         cl.pos = "n", 
         order = "original")
```

### P-Value correlation matrix. Site C

```{r}

selected_columns <- c("year_of_plantation",
           "x_coordinate",
           "y_coordinate",
           "species",
           "dbh",
           "height_m",
           "crown_dia_m",
           "total_c",
           "total_c_t_ha_34")

# Apply to the preprocessed data
p_value_matrix_signif <- calculate_p_values_signif(mangrove_recipe, selected_columns)

# Print the matrix with significance codes
print(p_value_matrix_signif)

```

```{r}

colored_df <- as.data.frame.matrix(p_value_matrix_signif)

colored_df[3,1] <- cell_spec(colored_df[3,1], "html", background = "orange")
colored_df[1,3] <- cell_spec(colored_df[1,3], "html", background = "orange")
colored_df[2,1] <- cell_spec(colored_df[2,1], "html", background = "lightyellow")
colored_df[1,2] <- cell_spec(colored_df[1,2], "html", background = "lightyellow")

# Now, print the colored matrix as a table with the additional cells colored
kable(colored_df, "html", 
      align = "c",
      escape = FALSE, booktabs = TRUE, caption = "P-Value Significance Matrix. SITE C") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = F)

```

### 
